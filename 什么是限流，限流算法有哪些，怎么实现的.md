## 什么是限流？限流算法有哪些？怎么实现的

这是 **高并发 / 微服务 面试必考题**。我按 **是什么 → 为什么 → 算法 → 实现方式 → 面试总结一句话** 给你一套**可直接背的答案**。

## 面试总结一句话

> **限流是通过控制单位时间内的请求数量来保护系统，常见算法包括固定窗口、滑动窗口、漏桶和令牌桶，其中令牌桶最常用，工程上通常通过网关或 Redis 实现分布式限流。**

------

## 一、什么是限流？

> **限流是指对单位时间内的请求数量进行控制，防止系统因突发或恶意流量而被压垮，是系统自我保护的一种手段。**

### 解决什么问题？

- 防止瞬时流量打爆 CPU / DB
- 避免雪崩效应
- 保障核心业务可用

------

## 二、为什么要限流？（面试官关心）

- 资源有限（线程、连接、CPU）
- 上游不可靠（突发流量、爬虫）
- 下游脆弱（DB / MQ）

------

## 三、常见限流算法（重点 ⭐）

------

## 1️⃣ 固定窗口（Fixed Window）

### 原理

- 以固定时间窗口统计请求数
- 超过阈值直接拒绝

### 示例

```
1 秒内最多 100 次请求
```

### 缺点

- 临界问题（窗口边界突刺）

📌 面试点评：

> 实现简单，但不精确

------

## 2️⃣ 滑动窗口（Sliding Window）

### 原理

- 将窗口拆成多个小格
- 滚动统计请求数

### 优点

- 更平滑
- 精度高

### 缺点

- 计算和存储成本高

------

## 3️⃣ 漏桶算法（Leaky Bucket）

### 原理

- 请求先进入桶
- 以固定速率流出
- 桶满丢弃

### 特点

- **强行平滑流量**

### 适用

- 需要稳定输出速率

------

## 4️⃣ 令牌桶算法（Token Bucket ⭐）

### 原理

- 按固定速率生成令牌
- 请求消耗令牌
- 可积累令牌 → 支持突发流量

### 优点

- 最常用
- 灵活

📌 常见实现：

- Guava RateLimiter
- Sentinel

------

## 四、限流算法对比（必背表）

| 算法     | 是否平滑 | 是否支持突发 | 实现复杂度 |
| -------- | -------- | ------------ | ---------- |
| 固定窗口 | ❌        | ❌            | 低         |
| 滑动窗口 | ✅        | ❌            | 高         |
| 漏桶     | ✅        | ❌            | 中         |
| 令牌桶   | ✅        | ✅            | 中         |

------

## 五、限流如何实现？（工程角度 ⭐）

------

### 1️⃣ 单机限流（本地）

- AtomicLong / CAS
- Guava RateLimiter

适合：

- 单实例
- 简单场景

------

### 2️⃣ 分布式限流（重点）

#### Redis + Lua（最常见 ⭐）

```
-- 判断并自增
if redis.call('get', key) < limit then
  redis.call('incr', key)
  redis.call('expire', key, window)
  return 1
else
  return 0
end
```

特点：

- 原子性
- 高性能

------

### 3️⃣ 网关层限流（生产推荐）

- Nginx limit_req
- Spring Cloud Gateway
- Kong / Envoy

------

### 4️⃣ 框架支持

- Sentinel
- Resilience4j

------

## 六、限流失败后的处理方式（面试必问）

- 直接拒绝（429）
- 排队
- 降级返回兜底数据
- 熔断

