## çº¿ä¸Šå‘ç° Redis æœºå™¨çˆ†äº†ï¼Œå¦‚ä½•ä¼˜åŒ–

è¿™æ˜¯**éå¸¸å…¸å‹çš„çº¿ä¸Šæ•…éšœ + æ¶æ„æ€ç»´é¢è¯•é¢˜**ï¼Œé¢è¯•å®˜ä¸æ˜¯è¦ä½ ä¸€å¥â€œåŠ æœºå™¨â€ï¼Œè€Œæ˜¯çœ‹ä½ **å¦‚ä½•å®šä½åŸå›  + ç»™å‡ºç³»ç»Ÿæ€§ä¼˜åŒ–æ–¹æ¡ˆ**ã€‚ä¸‹é¢ç»™ä½ ä¸€å¥— **å¯ç›´æ¥åœ¨é¢è¯•ä¸­å¤è¿°çš„ç­”æ¡ˆç»“æ„**ã€‚

------

## é¢è¯•æ€»ç»“ä¸€å¥è¯

> **Redis çº¿ä¸Šé—®é¢˜ä¼˜åŒ–çš„æ ¸å¿ƒæ€è·¯æ˜¯ï¼šå…ˆæ­¢è¡€ï¼Œå†å®šä½ç“¶é¢ˆï¼Œæœ€åä» Key è®¾è®¡ã€ç¼“å­˜æ¶æ„å’Œé›†ç¾¤åŒ–ä¸‰ä¸ªå±‚é¢æ ¹æ²»ã€‚**

------

## ä¸€ã€å…ˆç¨³ä½ï¼šçº¿ä¸Šåº”æ€¥å¤„ç†ï¼ˆæ­¢è¡€ï¼‰

**ç›®æ ‡ï¼šé˜²æ­¢é›ªå´©ï¼Œå¿«é€Ÿæ¢å¤æœåŠ¡**

1ï¸âƒ£ **é™æµ / é™çº§**

- ç½‘å…³ã€ä¸šåŠ¡ä¾§é™æµ
- éæ ¸å¿ƒ Redis è¯·æ±‚ç›´æ¥é™çº§
- é˜²æ­¢æ›´å¤šæµé‡æ‰“è¿› Redis

2ï¸âƒ£ **æµé‡åˆ‡æ¢**

- ä¸´æ—¶åˆ‡èµ°çƒ­ç‚¹ä¸šåŠ¡
- å¼€å¯æœ¬åœ°ç¼“å­˜å…œåº•ï¼ˆå¦‚ Caffeineï¼‰

3ï¸âƒ£ **æ‰©å®¹å®ä¾‹ï¼ˆä¸´æ—¶ï¼‰**

- æ‰© Redis ä»èŠ‚ç‚¹
- æˆ–ä¸´æ—¶ Redis Cluster æ‰©å®¹

ğŸ‘‰ é¢è¯•å®˜è¦çš„æ˜¯ï¼š**ä½ å…ˆä¿è¯ä¸šåŠ¡ä¸æŒ‚**

------

## äºŒã€å®šä½â€œçˆ†äº†â€çš„åŸå› ï¼ˆæ ¸å¿ƒï¼‰

### 1ï¸âƒ£ CPU çˆ†äº†ï¼Ÿ

å¸¸è§åŸå› ï¼š

- å¤§ Keyï¼ˆvalue å¾ˆå¤§ï¼‰
- çƒ­ Keyï¼ˆé«˜å¹¶å‘è®¿é—®ï¼‰
- O(N) å‘½ä»¤ï¼ˆkeysã€smembersã€lrange å¤§èŒƒå›´ï¼‰

æ’æŸ¥ï¼š

```
redis-cli --hotkeys
redis-cli --bigkeys
INFO commandstats
```

------

### 2ï¸âƒ£ å†…å­˜çˆ†äº†ï¼Ÿ

å¸¸è§åŸå› ï¼š

- Key è®¾è®¡ä¸åˆç†
- TTL è®¾ç½®ç¼ºå¤±
- å†…å­˜ç¢ç‰‡ä¸¥é‡
- RDB / AOF + COW å¯¼è‡´å†…å­˜ç¿»å€

æ’æŸ¥ï¼š

```
INFO memory
```

------

### 3ï¸âƒ£ QPS çˆ†äº†ï¼Ÿ

å¸¸è§åŸå› ï¼š

- ç¼“å­˜ç©¿é€ / å‡»ç©¿
- è¯·æ±‚æœªé™æµ
- çƒ­ç‚¹ Key é›†ä¸­è®¿é—®

------

## ä¸‰ã€æ ¹å› çº§ä¼˜åŒ–æ–¹æ¡ˆï¼ˆé‡ç‚¹ï¼‰

### 1ï¸âƒ£ Key & æ•°æ®ç»“æ„ä¼˜åŒ–

- æ‹† **å¤§ Key**
- ä½¿ç”¨ Hash ä»£æ›¿å¤§é‡ String
- åˆç†è®¾ç½® TTLï¼Œé¿å…æ°¸ä¹… Key

ğŸ“Œ é¢è¯•å®˜åŠ åˆ†ç‚¹ï¼š**Redis æœ€æ€•å¤§ Key å’Œçƒ­ Key**

------

### 2ï¸âƒ£ ç¼“å­˜æ¶æ„ä¼˜åŒ–

1. **æœ¬åœ°ç¼“å­˜ + Redis**
   - çƒ­ç‚¹ Key æœ¬åœ°å…œåº•
2. **å¤šçº§ç¼“å­˜**
   - JVM Cache â†’ Redis â†’ DB
3. **çƒ­ç‚¹ Key æ‹†åˆ†**
   - `key:{shard}` åˆ†æ•£å‹åŠ›

------

### 3ï¸âƒ£ å‘½ä»¤ä¸ä½¿ç”¨æ–¹å¼ä¼˜åŒ–

- ç¦ç”¨æˆ–æ›¿æ¢ O(N) å‘½ä»¤
- Pipeline / Lua å‡å°‘ RTT
- åˆå¹¶è¯·æ±‚ï¼Œå‡å°‘ QPS

------

### 4ï¸âƒ£ æŒä¹…åŒ– & å†…å­˜ä¼˜åŒ–

- è°ƒæ•´ RDB é¢‘ç‡
- AOF ä½¿ç”¨ `everysec`
- åˆç†é¢„ç•™ COW å†…å­˜
- å¼€å¯ `activedefrag`

------

### 5ï¸âƒ£ æ¶æ„çº§ä¼˜åŒ–ï¼ˆæ ¹æ²»ï¼‰

- Redis Cluster åˆ†ç‰‡
- çƒ­ç‚¹ä¸šåŠ¡æ‹† Redis å®ä¾‹
- è¯»å†™åˆ†ç¦»ï¼ˆåªè¯»å‰¯æœ¬ï¼‰
- æœåŠ¡ç«¯é™æµ + ç†”æ–­

------

## å››ã€å…¸å‹é¢è¯•å›ç­”æ¨¡æ¿ï¼ˆ2 åˆ†é’Ÿç‰ˆï¼‰

> **çº¿ä¸Š Redis çˆ†äº†ï¼Œæˆ‘ä¼šå…ˆé™æµé™çº§æ­¢è¡€ï¼Œç„¶åä» CPUã€å†…å­˜å’Œ QPS ä¸‰ä¸ªç»´åº¦æ’æŸ¥åŸå› ï¼Œé‡ç‚¹æ£€æŸ¥æ˜¯å¦å­˜åœ¨å¤§ Keyã€çƒ­ Key æˆ– O(N) å‘½ä»¤ã€‚ä¼˜åŒ–ä¸Šä¼šä» Key è®¾è®¡ã€ç¼“å­˜æ¶æ„ã€å‘½ä»¤ä½¿ç”¨ã€æŒä¹…åŒ–ç­–ç•¥å’Œé›†ç¾¤æ‹†åˆ†ç­‰æ–¹é¢å…¥æ‰‹ï¼Œæœ€ç»ˆé€šè¿‡å¤šçº§ç¼“å­˜å’Œ Redis Cluster ä»æ¶æ„ä¸Šè§£å†³é—®é¢˜ã€‚**

------

## å…­ã€é¢è¯•å®˜å¸¸ç»§ç»­è¿½é—®

- â“ çƒ­ Key å¦‚ä½•å‘ç°ï¼Ÿå¦‚ä½•è§£å†³ï¼Ÿ
- â“ å¤§ Key ä¸€å®šä¸å¥½å—ï¼Ÿ
- â“ Redis å†…å­˜ç¢ç‰‡å¦‚ä½•å¤„ç†ï¼Ÿ
- â“ ä¸ºä»€ä¹ˆ Redis å•çº¿ç¨‹ä¹Ÿèƒ½é«˜æ€§èƒ½ï¼Ÿ
- â“ Redis Cluster å¦‚ä½•æ‰©å®¹ï¼Ÿ

## 1ï¸âƒ£ çƒ­ Key å¦‚ä½•å‘ç°ï¼Ÿå¦‚ä½•è§£å†³ï¼Ÿ

### å¦‚ä½•å‘ç°ï¼ˆå®šä½ï¼‰

**çº¿ä¸Šå¸¸ç”¨æ‰‹æ®µï¼š**

1. **Redis å†…ç½®**

```
redis-cli --hotkeys
INFO commandstats
```

1. **ä¸šåŠ¡ä¾§ç»Ÿè®¡**

- åœ¨ä»£ç é‡Œç»Ÿè®¡ key çš„è®¿é—®é¢‘ç‡
- APM / æ—¥å¿—é‡‡æ ·

1. **ä»£ç†æˆ–ä¸­é—´ä»¶**

- Twemproxyã€Codis
- ç›‘æ§ key QPS

------

### å¦‚ä½•è§£å†³ï¼ˆæ²»ç†ï¼‰

1. **Key æ‹†åˆ†**

```
hot_key -> hot_key:{0..N}
```

1. **æœ¬åœ°ç¼“å­˜**

- JVM æœ¬åœ°ç¼“å­˜ï¼ˆCaffeineï¼‰
- å‡å°‘ Redis è®¿é—®

1. **åªè¯»å‰¯æœ¬**

- Redis Replica åˆ†æ‹…è¯»è¯·æ±‚

1. **é™æµ / é™çº§**

- å¯¹çƒ­ç‚¹æ¥å£é™æµ

------

### é¢è¯•ä¸€å¥è¯

> **çƒ­ Key å¯é€šè¿‡ Redis ç›‘æ§å’Œä¸šåŠ¡ç»Ÿè®¡å‘ç°ï¼Œå¸¸ç”¨æ‹† Keyã€æœ¬åœ°ç¼“å­˜å’Œå‰¯æœ¬åˆ†æ‹…è¯»æ¥è§£å†³ã€‚**

------

## 2ï¸âƒ£ å¤§ Key ä¸€å®šä¸å¥½å—ï¼Ÿ

### ç»“è®º

> **å¤§ Key ä¸ä¸€å®šä¸å¥½ï¼Œä½†åœ¨é«˜å¹¶å‘åœºæ™¯éå¸¸å±é™©ã€‚**

### é£é™©ç‚¹

- å•æ¬¡æ“ä½œè€—æ—¶é•¿
- é˜»å¡ä¸»çº¿ç¨‹
- è§¦å‘ RDB / AOF COW å†…å­˜æš´æ¶¨
- ç½‘ç»œä¼ è¾“æ…¢

### ä»€ä¹ˆæ—¶å€™å¯ä»¥æ¥å—ï¼Ÿ

- åªè¯»ã€ä½é¢‘è®¿é—®
- ç¦»çº¿åœºæ™¯

------

### é¢è¯•ä¸€å¥è¯

> **å¤§ Key å¹¶éç»å¯¹ç¦æ­¢ï¼Œä½†åœ¨é«˜å¹¶å‘åœ¨çº¿ç³»ç»Ÿä¸­åº”å°½é‡æ‹†åˆ†ï¼Œé¿å…é˜»å¡å’Œå†…å­˜é£é™©ã€‚**

------

## 3ï¸âƒ£ Redis å†…å­˜ç¢ç‰‡å¦‚ä½•å¤„ç†ï¼Ÿ

### åŸå› 

- é¢‘ç¹ç”³è¯· / é‡Šæ”¾å†…å­˜
- jemalloc å†…å­˜ç®¡ç†æœºåˆ¶
- å¤§ Key åˆ é™¤

### æ’æŸ¥

```
INFO memory
# å…³æ³¨ mem_fragmentation_ratio
```

### è§£å†³æ–¹æ¡ˆ

1. **å¼€å¯ä¸»åŠ¨ç¢ç‰‡æ•´ç†**

```
activedefrag yes
```

1. **é¿å…å¤§ Key**
2. **åˆç† TTL**
3. **ä½å³°æœŸé‡å¯å®ä¾‹**

------

### é¢è¯•ä¸€å¥è¯

> **Redis å†…å­˜ç¢ç‰‡ä¸»è¦ç”±é¢‘ç¹å†…å­˜åˆ†é…é€ æˆï¼Œå¯é€šè¿‡ä¸»åŠ¨ç¢ç‰‡æ•´ç†å’Œä¼˜åŒ– Key è®¾è®¡è§£å†³ã€‚**

------

## 4ï¸âƒ£ ä¸ºä»€ä¹ˆ Redis å•çº¿ç¨‹ä¹Ÿèƒ½é«˜æ€§èƒ½ï¼Ÿ

### æ ¸å¿ƒåŸå› ï¼ˆå¿…èƒŒ â­ï¼‰

1. **çº¯å†…å­˜æ“ä½œ**
2. **IO å¤šè·¯å¤ç”¨ï¼ˆepollï¼‰**
3. **æ— é”ç«äº‰**
4. **å‘½ä»¤æ‰§è¡Œå¿«ï¼ˆO(1) ä¸ºä¸»ï¼‰**
5. **å¤šçº¿ç¨‹å¤„ç† IOï¼ˆRedis 6+ï¼‰**

------

### é¢è¯•ä¸€å¥è¯

> **Redis é€šè¿‡å†…å­˜æ“ä½œã€IO å¤šè·¯å¤ç”¨å’Œæ— é”è®¾è®¡ï¼Œå³ä½¿å•çº¿ç¨‹æ‰§è¡Œå‘½ä»¤ä¹Ÿèƒ½è¾¾åˆ°é«˜æ€§èƒ½ã€‚**

------

## 5ï¸âƒ£ Redis Cluster å¦‚ä½•æ‰©å®¹ï¼Ÿ

### æ‰©å®¹æµç¨‹

1. **æ–°å¢èŠ‚ç‚¹**

```
redis-server
```

1. **åŠ å…¥é›†ç¾¤**

```
redis-cli --cluster add-node
```

1. **é‡æ–°åˆ†é…æ§½ä½**

```
redis-cli --cluster reshard
```

1. **æ•°æ®è¿ç§»**

- è‡ªåŠ¨è¿ç§» key
- å®¢æˆ·ç«¯æ— æ„ŸçŸ¥

------

### æ‰©å®¹æ³¨æ„ç‚¹

- æ§½è¿ç§»æœŸé—´æ€§èƒ½ä¸‹é™
- å»ºè®®ä½å³°æœŸæ“ä½œ
- ä¸»ä»å…³ç³»åŒæ­¥è°ƒæ•´

------

### é¢è¯•ä¸€å¥è¯

> **Redis Cluster é€šè¿‡å¢åŠ èŠ‚ç‚¹å¹¶é‡æ–°åˆ†é…æ§½ä½å®ç°åœ¨çº¿æ‰©å®¹ï¼Œå®¢æˆ·ç«¯å‡ ä¹æ— æ„ŸçŸ¥ã€‚**

------

## ğŸ§  Redis é«˜é¢‘è¿½é—® 30 ç§’é€Ÿè®°ç‰ˆ

> - çƒ­ Keyï¼šç›‘æ§å‘ç°ï¼Œæ‹† Key + æœ¬åœ°ç¼“å­˜
> - å¤§ Keyï¼šé«˜å¹¶å‘åœºæ™¯å±é™©
> - å†…å­˜ç¢ç‰‡ï¼šä¸»åŠ¨æ•´ç† + ä¼˜åŒ– Key
> - å•çº¿ç¨‹å¿«ï¼šå†…å­˜ + epoll + æ— é”
> - é›†ç¾¤æ‰©å®¹ï¼šåŠ èŠ‚ç‚¹ + reshard