## JDK 1.8 å¯¹ HashMap é™¤äº†çº¢é»‘æ ‘è¿˜è¿›è¡Œäº†å“ªäº›æ”¹åŠ¨ï¼Ÿ

å®žé™…ä¸Šï¼Œ**JDK 1.8 å¯¹ HashMap æ˜¯ä¸€æ¬¡ç³»ç»Ÿæ€§é‡æž„**ï¼Œçº¢é»‘æ ‘åªæ˜¯å…¶ä¸­ä¸€ä¸ªç‚¹ã€‚

ä¸‹é¢æˆ‘ä»Ž**ç»“æž„ã€put é€»è¾‘ã€æ‰©å®¹ã€hashã€é“¾è¡¨ã€å¹¶å‘å®‰å…¨ã€API è¯­ä¹‰**å‡ ä¸ªç»´åº¦ï¼ŒæŠŠ **1.7 â†’ 1.8 çš„æ‰€æœ‰å…³é”®æ”¹åŠ¨**ä¸€æ¬¡æ€§è®²æ¸…æ¥šã€‚

## é¢è¯•ä¸€å¥è¯æ€»ç»“ï¼ˆç›´æŽ¥èƒŒï¼‰

> **JDK 1.8 å¯¹ HashMap çš„æ”¹åŠ¨ä¸ä»…æ˜¯å¼•å…¥çº¢é»‘æ ‘ï¼Œè¿˜åŒ…æ‹¬å°¾æ’æ³•ã€é˜²æ­¢æ‰©å®¹æ­»å¾ªçŽ¯ã€ä¼˜åŒ– hash æ‰°åŠ¨å‡½æ•°ã€æ”¹è¿› resize è¿ç§»ç­–ç•¥ä»¥åŠæ•´ä½“ put/get é€»è¾‘é‡æž„ï¼Œä»Žæ€§èƒ½ã€ç¨³å®šæ€§å’Œå®‰å…¨æ€§ä¸‰ä¸ªå±‚é¢å…¨é¢æå‡äº† HashMapã€‚**

------

## ä¸€ã€æ•°æ®ç»“æž„å±‚é¢çš„æ”¹åŠ¨ï¼ˆä¸æ­¢çº¢é»‘æ ‘ï¼‰

### 1ï¸âƒ£ é“¾è¡¨æ’å…¥æ–¹å¼ï¼š**å¤´æ’æ³• â†’ å°¾æ’æ³•** â­â­â­

| ç‰ˆæœ¬    | æ’å…¥æ–¹å¼   |
| ------- | ---------- |
| JDK 1.7 | å¤´æ’æ³•     |
| JDK 1.8 | **å°¾æ’æ³•** |

#### JDK 1.7ï¼ˆå¤´æ’ï¼‰

```
newNode â†’ oldHead â†’ ...
```

âŒ é—®é¢˜ï¼š

- æ‰©å®¹æ—¶å¤šçº¿ç¨‹å¯èƒ½å½¢æˆ**çŽ¯å½¢é“¾è¡¨**
- `get()` æ­»å¾ªçŽ¯ï¼ˆè‘—å bugï¼‰

#### JDK 1.8ï¼ˆå°¾æ’ï¼‰

```
oldTail â†’ newNode
```

âœ… æ”¶ç›Šï¼š

- é¿å…é“¾è¡¨åè½¬
- æ¶ˆé™¤æ­»å¾ªçŽ¯é£Žé™©
- æ’å…¥é¡ºåºæ›´ç¬¦åˆç›´è§‰

------

## äºŒã€hash è®¡ç®—æ–¹å¼ä¼˜åŒ–

### JDK 1.8 çš„ hash æ‰°åŠ¨å‡½æ•°

```
static final int hash(Object key) {
    int h;
    return (key == null) ? 0 : (h = key.hashCode()) ^ (h >>> 16);
}
```

### æ”¹åŠ¨ç‚¹

- é«˜ 16 ä½å‚ä¸Žè¿ç®—
- é™ä½Žä½Žä½å†²çª

ðŸ‘‰ **é…åˆ (n - 1) & hash ä½¿ç”¨ï¼Œåˆ†å¸ƒæ›´å‡åŒ€**

------

## ä¸‰ã€æ‰©å®¹ï¼ˆresizeï¼‰æœºåˆ¶å½»åº•ä¼˜åŒ– â­â­â­

### 1ï¸âƒ£ JDK 1.7ï¼šå…¨é‡ rehash

- æ‰©å®¹ = æ‰€æœ‰å…ƒç´ é‡æ–°è®¡ç®— index
- æˆæœ¬é«˜
- è¿ç§»è¿‡ç¨‹ä¸­é“¾è¡¨é¡ºåºåè½¬

------

### 2ï¸âƒ£ JDK 1.8ï¼š**æ— éœ€é‡æ–° hash**

#### æ ¸å¿ƒåˆ¤æ–­é€»è¾‘

```
if ((hash & oldCap) == 0) {
    // ä½ç½®ä¸å˜
} else {
    // æ–°ä½ç½® = index + oldCap
}
```

ðŸš€ ä¼˜ç‚¹ï¼š

- ä¸ç”¨é‡æ–°è®¡ç®— hash
- æ‰©å®¹æˆæœ¬é™ä½Ž 50%+
- é“¾è¡¨é¡ºåºä¿æŒ

------

## å››ã€resize è¿‡ç¨‹ä¸­çš„ç»“æž„ä¼˜åŒ–

### æ‹†åˆ†é“¾è¡¨ï¼ˆsplitï¼‰

```
æ—§é“¾è¡¨
 â†“
ä½Žä½é“¾è¡¨ï¼ˆindex ä¸å˜ï¼‰
é«˜ä½é“¾è¡¨ï¼ˆindex + oldCapï¼‰
```

- ä¿è¯å…ƒç´ ç›¸å¯¹é¡ºåº
- çº¢é»‘æ ‘ä¹Ÿæ”¯æŒæ‹†åˆ†ï¼ˆtree splitï¼‰

------

## äº”ã€put æµç¨‹é‡æž„ï¼ˆé€»è¾‘æ›´æ¸…æ™°ï¼‰

### JDK 1.8 put() ç‰¹ç‚¹

- ç©ºæ¡¶ï¼šç›´æŽ¥æ’å…¥
- éžç©ºæ¡¶ï¼š
  - å…ˆåˆ¤æ–­å¤´èŠ‚ç‚¹
  - å†éåŽ†é“¾è¡¨ / çº¢é»‘æ ‘
- æ’å…¥å®ŒæˆåŽå†åˆ¤æ–­æ˜¯å¦éœ€è¦ treeify / resize

ðŸ‘‰ é€»è¾‘æ›´çº¿æ€§ï¼Œå¯è¯»æ€§å¤§å¹…æå‡

------

## å…­ã€get / containsKey ç­‰æŸ¥è¯¢è·¯å¾„ä¼˜åŒ–

- **å…ˆåˆ¤æ–­æ¡¶å¤´**
- å‘½ä¸­çŽ‡æ›´é«˜
- å‡å°‘ä¸å¿…è¦çš„éåŽ†

------

## ä¸ƒã€å¯¹ null çš„å¤„ç†æ›´ä¸¥è°¨

| è¡Œä¸º       | JDK 1.7 | JDK 1.8  |
| ---------- | ------- | -------- |
| null key   | æ”¯æŒ    | æ”¯æŒ     |
| null value | æ”¯æŒ    | æ”¯æŒ     |
| hash è®¡ç®—  | åˆ†æ•£    | ç»Ÿä¸€å°è£… |

------

## å…«ã€è¿­ä»£å™¨ï¼ˆIteratorï¼‰å®‰å…¨æ€§å¢žå¼º

- ä»æ˜¯ **fail-fast**
- modCount æ›´æ–°ç‚¹æ›´å‡†ç¡®
- å‡å°‘è¯¯æŠ¥ ConcurrentModificationException çš„æ¦‚çŽ‡

------

## ä¹ã€æ€§èƒ½å’Œå®‰å…¨å±‚é¢çš„æ”¶ç›Šæ€»ç»“

### æ€§èƒ½æå‡

- æ‰©å®¹æ›´å¿«
- é«˜å†²çªä¸‹æŸ¥è¯¢æ›´å¿«
- æ™®é€šåœºæ™¯æ€§èƒ½ä¸é™åå‡

### å®‰å…¨æ€§æå‡

- é˜²æ­¢ hash å†²çªæ”»å‡»
- æ¶ˆé™¤ JDK 1.7 çŽ¯å½¢é“¾è¡¨æ­»å¾ªçŽ¯é£Žé™©

------

## åã€JDK 1.8 HashMap æ”¹åŠ¨é€ŸæŸ¥è¡¨ï¼ˆé¢è¯•ç”¨ï¼‰

| æ¨¡å—       | JDK 1.7     | JDK 1.8        |
| ---------- | ----------- | -------------- |
| é“¾è¡¨æ’å…¥   | å¤´æ’æ³•      | **å°¾æ’æ³•**     |
| å†²çªç»“æž„   | é“¾è¡¨        | é“¾è¡¨ + çº¢é»‘æ ‘  |
| æ‰©å®¹       | å…¨é‡ rehash | **ä½è¿ç®—æ‹†åˆ†** |
| é“¾è¡¨é¡ºåº   | å¯èƒ½åè½¬    | ä¿æŒ           |
| hash æ‰°åŠ¨  | å¤šæ¬¡        | ç®€åŒ–ä½†æœ‰æ•ˆ     |
| æ­»å¾ªçŽ¯é£Žé™© | æœ‰          | **æ— **         |

------

> 