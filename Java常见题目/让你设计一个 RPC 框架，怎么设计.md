## 让你设计一个 RPC 框架，怎么设计

这是**高级后端 / 架构面试的经典题**，面试官并不是要你“造一个 Dubbo”，而是看你是否具备 **系统拆解能力、关键技术取舍能力、工程意识**。
 下面给你一套**标准高分回答模板**，按 **目标 → 架构 → 核心模块 → 关键难点 → 一句话总结** 来答，基本稳过。

# 面试总结一句话

> **设计 RPC 框架需要围绕代理、协议、序列化、网络通信、注册发现和治理能力进行模块化拆解，通过 Netty + 动态代理 + 可插拔机制实现高性能、可扩展和高可用的远程调用。**

# 一、先明确目标（先别写代码）

> **RPC 的本质：让远程方法调用像本地调用一样简单、可靠、可扩展。**

设计目标通常包括：

- 高性能、低延迟
- 支持服务发现与负载均衡
- 可扩展（协议、序列化、注册中心）
- 高可用（超时、重试、容错）
- 易用（注解、接口化）

------

# 二、整体架构设计（先画大图）

```
Consumer                    Provider
  |                              |
  |--- Proxy 层 (动态代理) ------>|
  |--- 编码/序列化 -------------->|
  |--- 网络传输 (Netty) --------->|
  |<-- 解码/反序列化 -------------|
  |<-- 结果返回 ------------------|
         ↑
     注册中心（ZK / Nacos）
```

------

# 三、核心模块拆解（重点 ⭐）

## 1️⃣ 接口代理层（Proxy）

**作用**

- 将本地方法调用 → RPC 请求

**实现**

- JDK 动态代理 / CGLIB
- 拦截方法 → 构建 RPC Request

```
invoke(method, args) → RpcRequest
```

📌 面试点：

- 为什么用接口？
- 为什么动态代理？

------

## 2️⃣ 协议设计（Protocol）

### 必须包含

- 魔数（Magic Number）
- 版本号
- 请求 ID
- 序列化方式
- 消息类型（请求 / 响应 / 心跳）
- 数据长度
- 数据体

📌 面试点：

- 为什么要魔数？（防止误解析）
- 如何支持协议升级？

------

## 3️⃣ 序列化模块

| 方案     | 特点       |
| -------- | ---------- |
| JDK      | 慢、不安全 |
| JSON     | 可读性好   |
| Hessian  | 体积小     |
| Protobuf | 高性能     |
| Kryo     | 快、轻量   |

📌 设计要点：

- 可插拔（SPI）
- 兼容性

------

## 4️⃣ 网络通信层

**选择**

- Netty（NIO）

**能力**

- 长连接
- 异步
- 高并发

📌 面试点：

- 半包 / 粘包如何解决？
- 心跳机制怎么做？

------

## 5️⃣ 注册中心 & 服务发现

**功能**

- 服务注册
- 服务发现
- 健康检查

**实现**

- Zookeeper / Nacos / Etcd

📌 面试点：

- 客户端缓存地址
- Watch 机制
- 注册中心挂了怎么办？

------

## 6️⃣ 负载均衡

**策略**

- 随机
- 轮询
- 一致性 Hash
- 权重

📌 可插拔设计（策略模式）

------

## 7️⃣ 容错与治理（加分点 ⭐）

- 超时控制
- 重试机制
- 熔断（Sentinel）
- 限流
- 降级

📌 面试点：

- 为什么不默认重试？
- 幂等性如何保证？

------

## 8️⃣ 服务端调用处理

- 请求反序列化
- 反射调用目标方法
- 返回结果

📌 线程池隔离（防止拖垮服务）

------

# 四、关键难点 & 设计取舍（高级加分）

### 1️⃣ 同步 vs 异步

- 默认同步
- 支持 Future / CompletableFuture

### 2️⃣ 连接管理

- 连接池
- 复用 Channel

### 3️⃣ 安全

- 白名单
- Token
- TLS

### 4️⃣ 可观测性

- 日志
- TraceId
- Metrics

------

# 五、和现有 RPC 框架的对比（面试官爱听）

| 框架         | 特点               |
| ------------ | ------------------ |
| Dubbo        | 功能全面、生态成熟 |
| gRPC         | 强协议、跨语言     |
| Spring Cloud | HTTP 化、简单      |

📌 表达重点：

> **自己设计的是“简化版 Dubbo”，核心能力优先，避免过度设计**

