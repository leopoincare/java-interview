## Seata AT æ¨¡å¼çš„åº•å±‚åŽŸç†

ä¸‹é¢æˆ‘ç»™ä½ ä¸€å¥— **Seata ATï¼ˆAutomatic Transactionï¼‰æ¨¡å¼åº•å±‚åŽŸç†çš„å®Œæ•´æ•´ç†**ï¼Œè¿™æ˜¯**åˆ†å¸ƒå¼äº‹åŠ¡é¢è¯•æœ€å®¹æ˜“è¢«æ·±æŒ–çš„ç‚¹ä¹‹ä¸€**ã€‚æˆ‘æŒ‰ **æ•´ä½“æµç¨‹ â†’ æ ¸å¿ƒæœºåˆ¶ â†’ å…³é”®ç»†èŠ‚ â†’ é¢è¯•æ€»ç»“** æ¥è®²ï¼Œç›´æŽ¥å¯èƒŒã€‚

## é¢è¯•æ€»ç»“ä¸€å¥è¯

> **Seata AT æ¨¡å¼é€šè¿‡ä»£ç†æ•°æ®æºæ‹¦æˆª SQLï¼Œè®°å½•å‰åŽé•œåƒç”Ÿæˆ undo logï¼Œåœ¨å…¨å±€äº‹åŠ¡å›žæ»šæ—¶è‡ªåŠ¨è¡¥å¿ï¼Œå®žçŽ°ä½Žä¾µå…¥çš„åˆ†å¸ƒå¼äº‹åŠ¡ã€‚**

------

## 30 ç§’åŽ‹ç¼©èƒŒè¯µç‰ˆ

> AT æ¨¡å¼æ˜¯ Seata é»˜è®¤æ¨¡å¼ï¼Œé€šè¿‡ SQL æ‹¦æˆªå’Œ undo log å®žçŽ°ä¸¤é˜¶æ®µæäº¤ï¼Œæœ¬åœ°äº‹åŠ¡å…ˆæäº¤ï¼Œå¤±è´¥æ—¶é€šè¿‡ undo log å›žæ»šæ•°æ®ï¼Œé€‚åˆå¸¸è§„å¾®æœåŠ¡äº‹åŠ¡åœºæ™¯ã€‚

------

## ä¸€ã€AT æ¨¡å¼ä¸€å¥è¯æ¦‚æ‹¬ï¼ˆå…ˆæŠ›ç»“è®ºï¼‰

> **Seata AT æ¨¡å¼é€šè¿‡æ‹¦æˆªæœ¬åœ° SQLï¼Œè®°å½• before/after é•œåƒç”Ÿæˆ undo logï¼Œåœ¨éœ€è¦å›žæ»šæ—¶åå‘è¡¥å¿ï¼Œä»Žè€Œå®žçŽ°åˆ†å¸ƒå¼äº‹åŠ¡çš„è‡ªåŠ¨å›žæ»šã€‚**

å…³é”®è¯ï¼š**SQL æ‹¦æˆªã€undo logã€è¡Œé”ã€ä¸¤é˜¶æ®µæäº¤**

------

## äºŒã€AT æ¨¡å¼çš„æ•´ä½“æž¶æž„è§’è‰²å›žé¡¾

- **TMï¼ˆäº‹åŠ¡ç®¡ç†å™¨ï¼‰**
  - å¼€å¯/æäº¤/å›žæ»šå…¨å±€äº‹åŠ¡
- **TCï¼ˆäº‹åŠ¡åè°ƒå™¨ï¼‰**
  - ç»´æŠ¤å…¨å±€äº‹åŠ¡çŠ¶æ€
- **RMï¼ˆèµ„æºç®¡ç†å™¨ï¼‰**
  - æ‰§è¡Œæœ¬åœ°äº‹åŠ¡
  - è®°å½• undo log

------

## ä¸‰ã€AT æ¨¡å¼å®Œæ•´æ‰§è¡Œæµç¨‹ï¼ˆé‡ç‚¹ â­ï¼‰

### ç¬¬ä¸€é˜¶æ®µï¼ˆæ‰§è¡Œ + è®°å½•ï¼‰

1ï¸âƒ£ **TM å¼€å¯å…¨å±€äº‹åŠ¡**

```
@GlobalTransactional
```

2ï¸âƒ£ **RM æ‹¦æˆª SQL**

- Seata ä»£ç† DataSource
- æ‹¦æˆª `INSERT / UPDATE / DELETE`

3ï¸âƒ£ **ç”Ÿæˆé•œåƒ**

- **before image**ï¼šä¿®æ”¹å‰æ•°æ®
- **after image**ï¼šä¿®æ”¹åŽæ•°æ®

4ï¸âƒ£ **è®°å½• undo_log**

```
undo_log:
  xid
  branch_id
  rollback_info (before image)
```

5ï¸âƒ£ **æ‰§è¡Œæœ¬åœ°äº‹åŠ¡å¹¶æäº¤**

- æœ¬åœ°äº‹åŠ¡æäº¤
- è¡Œé”é‡Šæ”¾ï¼ˆä½†é€»è¾‘é”ä»å­˜åœ¨ï¼‰

------

### ç¬¬äºŒé˜¶æ®µï¼ˆæäº¤ / å›žæ»šï¼‰

#### âœ… å…¨å±€æäº¤

- TC é€šçŸ¥ RM æäº¤
- RM åˆ é™¤ undo_log
- äº‹åŠ¡ç»“æŸï¼ˆå¿«é€Ÿï¼‰

#### âŒ å…¨å±€å›žæ»š

- TC é€šçŸ¥ RM å›žæ»š
- RM æ ¹æ® undo_log åå‘è¡¥å¿
- æ¢å¤ before image

------

## å››ã€AT æ¨¡å¼çš„æ ¸å¿ƒæŠ€æœ¯ç‚¹ï¼ˆé¢è¯•å¿…é—®ï¼‰

### 1ï¸âƒ£ undo log æ˜¯ä»€ä¹ˆï¼Ÿ

- å­˜åœ¨ä¸šåŠ¡æ•°æ®åº“ä¸­
- ç”¨äºŽå›žæ»šæ•°æ®
- å’Œä¸šåŠ¡æ•°æ® **åŒäº‹åŠ¡æäº¤**

ðŸ“Œ ä¿è¯ undo log ä¸Žä¸šåŠ¡æ•°æ®ä¸€è‡´

------

### 2ï¸âƒ£ è¡Œé” + å…¨å±€é”

- **æ•°æ®åº“è¡Œé”**
  - ç¬¬ä¸€é˜¶æ®µæ‰§è¡ŒæœŸé—´ç”Ÿæ•ˆ
- **Seata å…¨å±€é”**
  - åœ¨ TC ä¾§ç»´æŠ¤
  - é˜²æ­¢å¹¶å‘äº‹åŠ¡ä¿®æ”¹ç›¸åŒè¡Œ

ðŸ“Œ æœ¬åœ°äº‹åŠ¡æäº¤åŽï¼Œ**è¡Œé”é‡Šæ”¾ï¼Œä½†å…¨å±€é”ä»ç„¶å­˜åœ¨**

------

### 3ï¸âƒ£ éš”ç¦»æ€§æ˜¯å¦‚ä½•ä¿è¯çš„ï¼Ÿ

- ä¿®æ”¹æ•°æ®å‰å…ˆç”³è¯· **å…¨å±€é”**
- å…¶ä»–äº‹åŠ¡éœ€ç­‰å¾…æˆ–å›žæ»š
- ä¿è¯ **å†™éš”ç¦»**

------

### 4ï¸âƒ£ ä¸ºä»€ä¹ˆ AT æ¨¡å¼æ€§èƒ½æœ‰å¼€é”€ï¼Ÿ

- SQL æ‹¦æˆª + è§£æž
- undo log è¯»å†™
- å…¨å±€é”ç«žäº‰
- TC ç½‘ç»œé€šä¿¡

------

## äº”ã€AT æ¨¡å¼çš„é™åˆ¶ï¼ˆé¢è¯•å®˜å–œæ¬¢é—®ï¼‰

1. **ä»…æ”¯æŒå…³ç³»åž‹æ•°æ®åº“**
2. **ä¸æ”¯æŒè·¨åº“ JOIN**
3. **ä¸é€‚åˆè¶…é«˜å¹¶å‘çƒ­ç‚¹æ•°æ®**
4. **å¯¹ä¸šåŠ¡ SQL æœ‰é™åˆ¶**
   - å¿…é¡»æœ‰ä¸»é”®
   - ä¸èƒ½æœ‰å¤æ‚å­æŸ¥è¯¢

------

## å…­ã€AT vs TCCï¼ˆé¢è¯•å¯¹æ¯”ï¼‰

| ç»´åº¦     | AT       | TCC            |
| -------- | -------- | -------------- |
| ä¾µå…¥æ€§   | ä½Ž       | é«˜             |
| æ€§èƒ½     | ä¸­       | é«˜             |
| ä¸€è‡´æ€§   | å¼ºä¸€è‡´   | æœ€ç»ˆä¸€è‡´       |
| é€‚ç”¨åœºæ™¯ | å¸¸è§„äº‹åŠ¡ | é«˜å¹¶å‘æ ¸å¿ƒé“¾è·¯ |

------

> 