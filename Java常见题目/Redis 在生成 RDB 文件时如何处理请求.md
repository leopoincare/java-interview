## Redis 在生成 RDB 文件时如何处理请求

这是一个**非常典型的 Redis 原理 + 面试追问题**，面试官主要考你对 **Redis 持久化、单线程模型和写时复制（COW）** 的理解。下面给你一套 **可直接背的标准答案**。

------

## 面试总结一句话

> **Redis 在生成 RDB 时通过 fork 子进程和写时复制机制保证主进程继续处理请求，仅在 fork 阶段有短暂阻塞。**

------

## 一、结论先行（面试直接说）

> **Redis 在生成 RDB 文件时，主进程仍然可以正常处理客户端请求，RDB 由子进程通过写时复制机制生成，不会阻塞 Redis 的读写请求。**

------

## 二、RDB 生成过程（一步一步）

以 `BGSAVE` 为例（最常见）：

### 1️⃣ 主进程 fork 子进程

- Redis 主进程执行 `fork()`
- 生成 **子进程**
- fork 过程会短暂阻塞（毫秒级）

------

### 2️⃣ 子进程生成 RDB 文件

- 子进程负责遍历内存数据
- 将数据写入临时 RDB 文件
- 完成后原子替换旧 RDB 文件

------

### 3️⃣ 主进程继续处理请求

- **读请求**：直接正常处理
- **写请求**：
  - 触发 **写时复制（Copy-On-Write）**
  - 被修改的内存页复制一份
  - 子进程继续读取旧数据

📌 保证：

- RDB 数据是 fork 时刻的快照
- 不影响主进程响应客户端

------

## 三、为什么不会阻塞请求？（核心原理）

### 1️⃣ 单线程 + 多进程配合

- 主进程：处理请求
- 子进程：生成 RDB

### 2️⃣ 写时复制（COW）

- 内存页只有在写入时才复制
- 读操作不复制
- 降低内存和性能开销

------

## 四、什么时候会有性能影响？

1. **fork 阶段**
   - 内存越大，fork 越慢
2. **写请求密集**
   - 触发大量 COW
   - 内存占用上升
3. **内存紧张**
   - 可能导致 swap，性能急剧下降

------

## 五、面试官常追问

### ❓ BGSAVE 和 SAVE 区别？

- `SAVE`：**阻塞主线程**
- `BGSAVE`：**子进程异步执行**

### ❓ RDB 会丢数据吗？

- 会，只能保存到上一次快照
- 通常配合 AOF 使用