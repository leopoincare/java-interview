##  Java ä¸­ ConcurrentHashMap 1.7 å’Œ 1.8 ä¹‹é—´æœ‰å“ªäº›åŒºåˆ«ï¼Ÿ

è¿™æ˜¯ **ConcurrentHashMap** çš„**ç»å…¸é«˜é¢‘é¢è¯•é¢˜**ã€‚JDK **1.7 â†’ 1.8** çš„å˜åŒ–éžå¸¸å¤§ï¼Œå‡ ä¹Žæ˜¯ä¸€æ¬¡**é‡æž„çº§å‡çº§**ã€‚ä¸‹é¢ä»Ž**ç»“æž„ã€å¹¶å‘æœºåˆ¶ã€æ€§èƒ½ã€æ‰©å®¹ã€API è¡Œä¸º**å‡ ä¸ªç»´åº¦ç³»ç»Ÿå¯¹æ¯”ã€‚

## é¢è¯•ä¸€å¥è¯æ€»ç»“

> **ConcurrentHashMap åœ¨ JDK 1.8 ä¸­å½»åº•ç§»é™¤äº† Segmentï¼Œé‡‡ç”¨ CAS + synchronized çš„æ›´ç»†ç²’åº¦é”è®¾è®¡ï¼Œå¹¶å¼•å…¥çº¢é»‘æ ‘å’ŒååŒæ‰©å®¹æœºåˆ¶ï¼Œä½¿å¹¶å‘æ€§èƒ½ã€æ‰©å±•æ€§å’Œç¨³å®šæ€§éƒ½æ˜¾è‘—ä¼˜äºŽ 1.7ã€‚**

------

## ä¸€ã€æ•´ä½“ç»“è®ºå…ˆç»™å‡ºï¼ˆé¢è¯•ç‰ˆï¼‰

> **JDK 1.7 çš„ ConcurrentHashMap åŸºäºŽ Segment åˆ†æ®µé”ï¼›
> JDK 1.8 åŽ»æŽ‰ Segmentï¼Œé‡‡ç”¨ CAS + synchronized + çº¢é»‘æ ‘ï¼Œé”ç²’åº¦æ›´ç»†ï¼Œå¹¶å‘æ€§èƒ½æ›´é«˜ã€‚**

------

## äºŒã€æ ¸å¿ƒç»“æž„å¯¹æ¯”

| ç‰ˆæœ¬        | åº•å±‚ç»“æž„                             |
| ----------- | ------------------------------------ |
| **JDK 1.7** | Segment æ•°ç»„ + HashEntry æ•°ç»„ + é“¾è¡¨ |
| **JDK 1.8** | Node æ•°ç»„ + é“¾è¡¨ / çº¢é»‘æ ‘            |

### 1ï¸âƒ£ JDK 1.7 ç»“æž„ï¼ˆåˆ†æ®µé”ï¼‰

```
ConcurrentHashMap
 â””â”€ Segment[]ï¼ˆé»˜è®¤ 16ï¼‰
      â””â”€ HashEntry[]ï¼ˆæ¡¶ï¼‰
           â””â”€ é“¾è¡¨
```

- **Segment ç»§æ‰¿ ReentrantLock**
- ä¸€ä¸ª Segment ç®¡ç†ä¸€éƒ¨åˆ†æ¡¶
- é”çš„æ˜¯ **æ•´ä¸ª Segment**

ðŸ”´ é—®é¢˜ï¼š

- é”ç²’åº¦è¾ƒç²—
- å¹¶å‘åº¦å— Segment æ•°é‡é™åˆ¶

------

### 2ï¸âƒ£ JDK 1.8 ç»“æž„ï¼ˆå–æ¶ˆ Segmentï¼‰

```
table[]
 â”œâ”€ Node â†’ é“¾è¡¨
 â”œâ”€ TreeNode â†’ çº¢é»‘æ ‘
```

- **æ²¡æœ‰ Segment**
- é”ç²’åº¦é™åˆ° **æ¡¶ / é“¾è¡¨ / æ ‘**
- å¼•å…¥ **CAS + synchronized**

------

## ä¸‰ã€å¹¶å‘æŽ§åˆ¶æœºåˆ¶å·®å¼‚ï¼ˆé‡ç‚¹ï¼‰

### ðŸ”¹ JDK 1.7ï¼šSegment åˆ†æ®µé”

- `put()`ï¼š
  - å…ˆå®šä½ Segment
  - å¯¹ Segment åŠ é”
  - å†æ“ä½œæ¡¶
- å¹¶å‘åº¦ = Segment æ•°é‡ï¼ˆé»˜è®¤ 16ï¼‰

```
segment.lock();
try {
   // put
} finally {
   segment.unlock();
}
```

âŒ ç¼ºç‚¹ï¼š

- å¤šçº¿ç¨‹è½åœ¨åŒä¸€ Segment ä»ä¼šé˜»å¡ž
- æ‰©å®¹éœ€è¦é” Segment

------

### ðŸ”¹ JDK 1.8ï¼šCAS + synchronized

#### put() æµç¨‹ï¼ˆç®€åŒ–ï¼‰

1. **CAS** æ’å…¥ç©ºæ¡¶
2. æ¡¶éžç©º â†’ `synchronized` é”ä½ **æ¡¶å¤´èŠ‚ç‚¹**
3. é“¾è¡¨ â‰¥ 8 â†’ çº¢é»‘æ ‘

```
if (casTabAt(...)) {
   // æ— é”æ’å…¥
} else {
   synchronized (f) {
       // é“¾è¡¨ / æ ‘æ“ä½œ
   }
}
```

âœ… ä¼˜ç‚¹ï¼š

- é”ç²’åº¦æ›´ç»†
- ä½Žå†²çªåœºæ™¯å‡ ä¹Žæ— é”
- é«˜å¹¶å‘ä¸‹åžåé‡æ›´é«˜

------

## å››ã€æ‰©å®¹ï¼ˆresizeï¼‰æœºåˆ¶å¯¹æ¯” â­

### ðŸ”¹ JDK 1.7

- æ¯ä¸ª Segment **ç‹¬ç«‹æ‰©å®¹**
- æ‰©å®¹æ—¶é”ä½æ•´ä¸ª Segment
- rehash æˆæœ¬é«˜

------

### ðŸ”¹ JDK 1.8ï¼ˆé©å‘½æ€§æ”¹è¿›ï¼‰

- **å¤šçº¿ç¨‹ååŒæ‰©å®¹**
- ä½¿ç”¨ `ForwardingNode` æ ‡è®°å·²è¿ç§»æ¡¶
- çº¿ç¨‹â€œå¸®å¿™â€è¿ç§»æ•°æ®

```
æ—§è¡¨ â”€â”€è¿ç§»â”€â”€â–¶ æ–°è¡¨
     â†‘
 ForwardingNode
```

ðŸš€ ä¼˜ç‚¹ï¼š

- æ‰©å®¹ä¸ä¼šé˜»å¡žæ‰€æœ‰çº¿ç¨‹
- å¤§è¡¨æ‰©å®¹æ€§èƒ½å¤§å¹…æå‡

------

## äº”ã€get() è¯»å–æ€§èƒ½å·®å¼‚

| ç‰ˆæœ¬    | get æ˜¯å¦åŠ é” |
| ------- | ------------ |
| JDK 1.7 | âŒ ä¸åŠ é”     |
| JDK 1.8 | âŒ ä¸åŠ é”     |

ä½†å®žçŽ°ä¸åŒï¼š

- **1.7**ï¼švolatile + unsafe ä¿è¯å¯è§æ€§
- **1.8**ï¼švolatile + Node ä¸å¯å˜è®¾è®¡

------

## å…­ã€çº¢é»‘æ ‘æ”¯æŒï¼ˆ1.8 æ–°å¢žï¼‰

| ç‰ˆæœ¬    | å†²çªå¤„ç†      |
| ------- | ------------- |
| JDK 1.7 | ä»…é“¾è¡¨        |
| JDK 1.8 | é“¾è¡¨ â†’ çº¢é»‘æ ‘ |

- æ ‘åŒ–é˜ˆå€¼ï¼š**8**
- æŸ¥æ‰¾å¤æ‚åº¦ï¼š`O(n)` â†’ `O(log n)`

------

## ä¸ƒã€size() å®žçŽ°å·®å¼‚

### ðŸ”¹ JDK 1.7

- éåŽ†æ‰€æœ‰ Segment
- ç»Ÿè®¡ count
- **å¯èƒ½ä¸å‡†ç¡®**
- å¤šæ¬¡é‡è¯•ä¿è¯è¿‘ä¼¼ä¸€è‡´

------

### ðŸ”¹ JDK 1.8

- ä½¿ç”¨ `baseCount + CounterCell[]`
- ç±»ä¼¼ LongAdder
- é«˜å¹¶å‘ä¸‹ç»Ÿè®¡æ›´å¿«ã€æ›´å‡†

------

## å…«ã€API è¡Œä¸ºå˜åŒ–ï¼ˆ1.8 æ–°å¢žï¼‰

### JDK 1.8 æ–°å¢žæ–¹æ³•

```
map.forEach()
map.computeIfAbsent()
map.merge()
map.reduce()
```

- åŽŸå­æ“ä½œ
- æ›´é€‚åˆå¹¶å‘ç»Ÿè®¡åœºæ™¯

------

## ä¹ã€å…³é”®å·®å¼‚ä¸€è§ˆè¡¨ï¼ˆé¢è¯•é€Ÿè®°ï¼‰

| å¯¹æ¯”ç‚¹    | JDK 1.7         | JDK 1.8            |
| --------- | --------------- | ------------------ |
| å¹¶å‘æŽ§åˆ¶  | Segment åˆ†æ®µé”  | CAS + synchronized |
| é”ç²’åº¦    | Segment         | æ¡¶ / èŠ‚ç‚¹          |
| æ‰©å®¹      | å• Segment æ‰©å®¹ | å¤šçº¿ç¨‹åä½œæ‰©å®¹     |
| æ•°æ®ç»“æž„  | é“¾è¡¨            | é“¾è¡¨ + çº¢é»‘æ ‘      |
| å¹¶å‘åº¦    | å›ºå®šï¼ˆé»˜è®¤ 16ï¼‰ | åŠ¨æ€ï¼Œç†è®ºæ›´é«˜     |
| size ç»Ÿè®¡ | éåŽ† Segment    | LongAdder æ€è·¯     |
| æ€§èƒ½      | ä¸­              | é«˜ï¼ˆæ˜¾è‘—æå‡ï¼‰     |

------

> 