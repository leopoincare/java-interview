## 线上系统 突然CPU和内存暴涨 如何排查问题

这是**线上故障排查的经典实战题**，面试官重点看你有没有**体系化思路 + 真正上过线的经验**。下面给你一套 **“能落地、能复盘、能复述”** 的排查流程。

------

## 面试总结一句话

> **线上 CPU 和内存暴涨时，应先止血保障业务，再通过系统指标、线程栈、GC 和堆分析逐步定位，常见根因包括死循环、GC 压力、内存泄漏及外部依赖异常。**

## 一、总原则（先保命，再定位）

> **先止血 → 再定位 → 最后根因分析和复盘**

------

## 二、第一步：快速止血（生产优先）

### 1️⃣ 判断是否影响业务

- 接口 RT 是否飙升
- 错误率（5xx）
- 下游是否被拖垮

### 2️⃣ 立即措施（按场景）

| 场景     | 操作            |
| -------- | --------------- |
| CPU 100% | 扩容 / 重启实例 |
| OOM 风险 | 提前滚动重启    |
| 流量突增 | 限流 / 降级     |
| 可疑发布 | 回滚版本        |

📌 **面试加分点**：

> *线上先保证 SLA，而不是先查日志*

------

## 三、第二步：确认是系统问题还是外部问题

### 关键判断

- 是否刚 **发布**
- 是否 **流量突增**
- 是否 **定时任务触发**
- 是否依赖系统异常（DB / MQ）

------

## 四、CPU 暴涨排查思路（重点 ⭐）

### 1️⃣ 定位进程

```
top
```

- 找到 CPU 占用最高的 PID

------

### 2️⃣ 定位线程（Java）

```
top -Hp pid
```

- 找到高 CPU 线程
- 记录 **线程 ID（十进制）**

```
printf "%x\n" tid   # 转 16 进制
```

------

### 3️⃣ Java 堆栈定位

```
jstack pid > stack.txt
```

- 搜索对应线程
- 常见问题：
  - 死循环
  - 频繁 GC
  - 锁竞争
  - 自旋 CAS

📌 常见原因：

- while(true)
- 错误的重试逻辑
- 正则灾难
- 热点锁

------

## 五、内存暴涨排查思路（重点 ⭐）

### 1️⃣ 快速判断类型

| 表现     | 可能原因          |
| -------- | ----------------- |
| 持续上涨 | 内存泄漏          |
| 锯齿型   | GC 压力           |
| 突然 OOM | 大对象 / 突发流量 |

------

### 2️⃣ JVM 观察

```
jstat -gc pid 1s
```

- Old 区是否持续增长
- Full GC 是否频繁

------

### 3️⃣ 导出堆

```
jmap -dump:live,format=b,file=heap.hprof pid
```

用工具：

- MAT
- VisualVM

重点看：

- 占用最大的对象
- 引用链（GC Roots）

------

### 4️⃣ 常见内存问题

- 缓存未设上限
- 集合无限增长
- ThreadLocal 未清理
- 大对象直接进老年代

------

## 六、CPU + 内存同时暴涨（高频）

### 常见组合原因

- **频繁 Full GC**
- 请求堆积 + 线程池耗尽
- 数据库慢 SQL 导致堆积
- 死循环创建对象

📌 经验口诀：

> **CPU 高不一定是业务，可能是 GC**

------

## 七、外部依赖排查（经常被忽略）

- DB 慢查询
- MQ 堆积
- Redis 阻塞
- 下游超时 → 重试风暴

------

## 八、日志 & 监控定位

### 重点看：

- 错误日志突增
- GC 日志
- 请求耗时分布（P99）

------

## 九、最终根因定位后要做什么（面试加分）

1. 修代码 / 参数
2. 补监控
3. 加限流 / 熔断
4. 压测验证
5. 故障复盘（RCA）

